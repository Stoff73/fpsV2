================================================================================
TenGo v0.2.12 DEPLOYMENT - QUICK COMMAND REFERENCE
================================================================================

Production URL: https://csjones.co/tengo
Version: v0.2.12 (Complete Patch - ALL 34 Sections)
Date: November 22, 2025

CRITICAL: 2 Database Changes Required
1. Production SQL: ALTER TABLE dc_pensions (MANUAL)
2. Migration: Add joint ownership to liabilities (AUTOMATED)

================================================================================
STEP 1: BACKUP DATABASE (5 MIN)
================================================================================

# Method 1: Admin Panel (RECOMMENDED)
1. Visit: https://csjones.co/tengo/admin
2. Login: admin@fps.com / admin123
3. Click: "Create Backup"
4. Download backup file
5. Save to: ~/Desktop/fps-backups/

# Method 2: SSH Manual Backup
ssh [username]@csjones.co -p18765
cd ~/tengo-app
grep "DB_" .env
mysqldump -u [DB_USER] -p[DB_PASSWORD] [DB_NAME] > backup-$(date +%Y%m%d-%H%M%S).sql
ls -lh backup-*.sql

================================================================================
STEP 2: UPDATE PRODUCTION .ENV (3 MIN)
================================================================================

ssh [username]@csjones.co -p18765
cd ~/tengo-app
cp .env .env.backup.$(date +%Y%m%d-%H%M%S)
nano .env

# Add these lines (REQUIRED for Section 3 - CORS):
ALLOWED_ORIGINS=https://csjones.co/tengo
FRONTEND_URL=https://csjones.co/tengo

# Verify:
APP_ENV=production
APP_DEBUG=false
APP_URL=https://csjones.co/tengo

# Save and exit: Ctrl+X, Y, Enter

grep "ALLOWED_ORIGINS" .env
grep "FRONTEND_URL" .env

================================================================================
STEP 3: UPLOAD FILES (10 MIN)
================================================================================

Total: 41 files (15 backend + 26 frontend)

# Create tarball on local machine:
cd ~/Desktop/fpsApp/tengo

tar -czf v0.2.12-patch.tar.gz \
  app/Http/Controllers/Api/AuthController.php \
  app/Http/Controllers/Api/Estate/TrustController.php \
  app/Http/Controllers/Api/FamilyMembersController.php \
  app/Http/Controllers/Api/InvestmentController.php \
  app/Http/Controllers/Api/MortgageController.php \
  app/Http/Controllers/Api/PropertyController.php \
  app/Http/Controllers/Api/UserProfileController.php \
  app/Models/User.php \
  app/Models/Estate/Liability.php \
  app/Models/Investment/InvestmentAccount.php \
  app/Services/Onboarding/OnboardingService.php \
  app/Services/UserProfile/UserProfileService.php \
  config/cors.php \
  routes/api.php \
  database/migrations/2025_11_22_092125_add_joint_ownership_to_liabilities_table.php \
  resources/js/components/Estate/GiftingStrategy.vue \
  resources/js/components/Estate/IHTMitigationStrategies.vue \
  resources/js/components/Estate/IHTPlanning.vue \
  resources/js/components/Investment/PortfolioOverview.vue \
  resources/js/components/NetWorth/NetWorthOverview.vue \
  resources/js/components/NetWorth/PropertyCard.vue \
  resources/js/components/NetWorth/Property/PropertyForm.vue \
  resources/js/components/Onboarding/steps/IncomeStep.vue \
  resources/js/components/Onboarding/steps/PersonalInfoStep.vue \
  resources/js/components/Retirement/DCPensionForm.vue \
  resources/js/components/Retirement/UnifiedPensionForm.vue \
  resources/js/components/UserProfile/ExpenditureOverview.vue \
  resources/js/composables/useDesignMode.js \
  resources/js/constants/taxConfig.js \
  resources/js/store/modules/protection.js \
  resources/js/views/Dashboard.vue \
  resources/js/views/Retirement/RetirementReadiness.vue

# Upload tarball:
scp -P 18765 v0.2.12-patch.tar.gz [username]@csjones.co:~/tengo-app/

# Extract on production:
ssh [username]@csjones.co -p18765
cd ~/tengo-app
tar -xzf v0.2.12-patch.tar.gz
rm v0.2.12-patch.tar.gz

================================================================================
STEP 4A: RUN PRODUCTION SQL - dc_pensions.provider (2 MIN)
================================================================================

CRITICAL: This MUST be run BEFORE migration

ssh [username]@csjones.co -p18765
cd ~/tengo-app

# Get credentials:
grep "DB_" .env

# Connect to MySQL:
mysql -u [DB_USER] -p[DB_PASSWORD] [DB_NAME]

# In MySQL prompt:
DESCRIBE dc_pensions;

ALTER TABLE dc_pensions MODIFY COLUMN provider varchar(255) NULL;

DESCRIBE dc_pensions;
-- Verify: provider column shows YES in Null column

EXIT;

================================================================================
STEP 4B: RUN MIGRATION - liabilities ownership (2 MIN)
================================================================================

cd ~/tengo-app

php artisan migrate --force

# Expected output:
# 2025_11_22_092125_add_joint_ownership_to_liabilities_table ......... DONE

# Verify:
php artisan migrate:status

mysql -u [DB_USER] -p[DB_PASSWORD] [DB_NAME] -e "DESCRIBE liabilities;"
# Should show: ownership_type, joint_owner_id, trust_id columns

================================================================================
STEP 5: BUILD FRONTEND (8 MIN)
================================================================================

cd ~/tengo-app

composer install --no-dev --optimize-autoloader
composer dump-autoload --optimize

npm ci
npm run build

# Verify:
ls -lh public/build/manifest.json
ls -lh public/build/assets/ | head -20

================================================================================
STEP 6: CLEAR CACHES AND RESTART (3 MIN)
================================================================================

cd ~/tengo-app

php artisan optimize:clear
php artisan config:cache
php artisan route:cache
php artisan view:cache
php artisan optimize

sudo systemctl restart php8.2-fpm
sudo systemctl restart nginx

# Verify services:
sudo systemctl status php8.2-fpm
sudo systemctl status nginx

================================================================================
STEP 7: VERIFY DEPLOYMENT (10 MIN)
================================================================================

# 1. Test homepage:
curl -I https://csjones.co/tengo

# 2. Test login:
Visit: https://csjones.co/tengo
Login: demo@fps.com / password

# 3. Test DC Pension without provider (Section 13 fix):
Navigate: Retirement → Add Pension → DC
Leave provider blank → Save
Expected: Success (no integrity constraint error)

# 4. Test State Pension save (Section 18 fix):
Navigate: Retirement → Add Pension → State
Fill fields → Save
Expected: Pension appears in card

# 5. Test joint investment display (Section 32 fix):
Navigate: Investment → Portfolio Overview
Expected: Joint accounts show "Full Value" and "Your Share"

# 6. Verify database changes:
cd ~/tengo-app
mysql -u [DB_USER] -p[DB_PASSWORD] [DB_NAME] < verify_v0.2.12_database.sql
# All checks should show PASS

# 7. Check logs:
tail -50 ~/tengo-app/storage/logs/laravel.log
sudo tail -50 /var/log/nginx/error.log
# Expected: No critical errors

================================================================================
STEP 8: MONITOR (30 MIN)
================================================================================

ssh [username]@csjones.co -p18765
tail -f ~/tengo-app/storage/logs/laravel.log

Watch for:
- Database errors (dc_pensions, liabilities)
- CORS errors
- 500 errors
- Authentication issues

================================================================================
ROLLBACK PROCEDURE (IF NEEDED)
================================================================================

# Quick Rollback (Code Only):
cd ~/tengo-app
git log --oneline -10
git checkout [PREVIOUS_COMMIT]
composer install --no-dev --optimize-autoloader
npm ci && npm run build
php artisan optimize:clear
php artisan config:cache
sudo systemctl restart php8.2-fpm nginx

# Database Rollback:
php artisan migrate:rollback --step=1

mysql -u [DB_USER] -p[DB_PASSWORD] [DB_NAME]
UPDATE dc_pensions SET provider = 'Unknown' WHERE provider IS NULL;
ALTER TABLE dc_pensions MODIFY COLUMN provider varchar(255) NOT NULL;
EXIT;

# Full Restore:
php artisan down
mysql -u [DB_USER] -p < storage/app/backups/backup-2025-11-22-HHMMSS.sql
php artisan up
sudo systemctl restart php8.2-fpm nginx

================================================================================
DEPLOYMENT CHECKLIST
================================================================================

PRE-DEPLOYMENT:
[ ] Database backup created
[ ] Backup downloaded locally
[ ] Git status clean
[ ] Local build test passed
[ ] SSH access confirmed

DEPLOYMENT:
[ ] .env updated (ALLOWED_ORIGINS, FRONTEND_URL)
[ ] All 41 files uploaded
[ ] Production SQL executed (dc_pensions.provider)
[ ] Migration completed (liabilities ownership)
[ ] Frontend assets built
[ ] Caches cleared
[ ] Services restarted

VERIFICATION:
[ ] Homepage loads
[ ] Login works
[ ] DC pension without provider works
[ ] State pension saves
[ ] Joint investments display correctly
[ ] Database verification passes
[ ] No errors in logs

POST-DEPLOYMENT:
[ ] Monitor logs for 30 minutes
[ ] Tag git commit: v0.2.12
[ ] Update .env with APP_VERSION=v0.2.12
[ ] Document any issues

================================================================================
SUCCESS CRITERIA
================================================================================

✅ All 41 files uploaded
✅ Production SQL executed successfully
✅ Migration completed successfully
✅ Frontend built (manifest.json exists)
✅ Caches cleared and rebuilt
✅ Services restarted
✅ All verification tests pass
✅ No critical errors in logs
✅ CORS uses production URLs only

================================================================================
CRITICAL SECTIONS COVERED
================================================================================

Security Fixes: 10 sections (1-10)
- Token logging removed
- Password validation improved
- CORS hardcoded origins removed (⚠️ .env update required)
- Trust route fixed
- N+1 query fixed
- User model switched to guarded

UI/Feature Fixes: 22 sections (11-32)
- Slippery mode default fix
- DC pension provider optional (⚠️ Production SQL required)
- State pension save working
- Joint investment display fixed
- Tenants in common support
- ISA allowance tracking
- Spouse data pre-population
- Financial commitments filtering
- Liabilities joint ownership (⚠️ Migration required)

Code Quality: 7 improvements (Section 34)
- Trust ownership for liabilities
- Null safety improvements
- Eloquent relationships added
- Code duplication reduced
- Better comments
- Centralized tax constants
- Naming consistency

================================================================================
DOCUMENTATION
================================================================================

Full Guide: DEPLOYMENT_PATCH_v0.2.12_COMPLETE_22Nov2025.md
Checklist: DEPLOYMENT_v0.2.12_CHECKLIST.md
Summary: DEPLOYMENT_v0.2.12_SUMMARY.md
Verification: verify_v0.2.12_database.sql
Source: friFixes21Nov.md (all 34 sections)

================================================================================
END OF QUICK REFERENCE
================================================================================

Generated: November 22, 2025
Version: v0.2.12
Built with Claude Code

TenGo v0.2.11 - RAPID DEPLOYMENT GUIDE
========================================
22 November 2025 Patch | MIGRATION INCLUDED | 20-25 minutes

⚠️  CRITICAL: Database migration included - BACKUP MANDATORY before proceeding!

========================================
ESSENTIAL INFO
========================================

What's Changed:
- 1 database migration (adds trust ownership to liabilities)
- 4 backend files (models/services)
- 4 frontend files (3 components + 1 NEW constants file)

Migration: 2025_11_22_092125_add_joint_ownership_to_liabilities_table.php
What it does: Adds ownership_type, joint_owner_id, trust_id to liabilities table
Impact: Additive only - no data loss, all existing records → 'individual'

========================================
FILES TO UPLOAD (9 total)
========================================

MIGRATION (1 file):
→ database/migrations/2025_11_22_092125_add_joint_ownership_to_liabilities_table.php

BACKEND (3 files):
→ app/Models/Estate/Liability.php
→ app/Services/Onboarding/OnboardingService.php
→ app/Services/UserProfile/UserProfileService.php

FRONTEND (4 files):
→ resources/js/constants/taxConfig.js (NEW - create directory first!)
→ resources/js/components/Estate/IHTMitigationStrategies.vue
→ resources/js/components/Estate/IHTPlanning.vue
→ resources/js/components/Investment/PortfolioOverview.vue

========================================
RAPID DEPLOYMENT STEPS
========================================

1. BACKUP DATABASE (MANDATORY)
   • Login: https://csjones.co/tengo/admin (admin@fps.com / admin123)
   • Admin Panel → Database Backup → Create Backup
   • Download backup file
   • Verify file size > 1MB

2. SSH CONNECT
   ssh [username]@csjones.co -p18765
   cd ~/tengo-app

3. BACKUP CODE
   backup_name="tengo-v0.2.10-backup-$(date +%Y%m%d-%H%M%S)"
   mkdir -p ~/backups/$backup_name
   cp -r app/Models/ app/Services/ ~/backups/$backup_name/
   cp -r resources/js/components/Estate/ ~/backups/$backup_name/estate/
   cp -r resources/js/components/Investment/ ~/backups/$backup_name/investment/

4. UPLOAD FILES
   • Create constants directory: mkdir -p resources/js/constants
   • Upload all 9 files via SFTP/File Manager to ~/tengo-app/

5. RUN MIGRATION
   php artisan migrate --force
   # Expected: "Migrated: 2025_11_22_092125... (0.15 seconds)"

6. VERIFY MIGRATION
   php artisan migrate:status | grep "2025_11_22"
   # Expected: "Ran | 2025_11_22_092125..."

7. REBUILD FRONTEND
   rm -rf public/build/*
   NODE_ENV=production npm run build
   # Expected: "✓ built in 18-25s"

8. VERIFY BUILD
   ls -la public/build/manifest.json
   ls public/build/assets/ | wc -l
   # Expected: manifest.json exists, 100+ asset files

9. CLEAR CACHES
   php artisan cache:clear
   php artisan view:clear
   php artisan config:clear
   php artisan route:clear
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache
   php artisan optimize
   chmod -R 775 storage bootstrap/cache

10. TEST APPLICATION
    • Visit: https://csjones.co/tengo
    • Login: demo@fps.com / password
    • Check dashboard loads
    • Check IHT Planning → Projected column note visible
    • Check Investment → ISA allowance displays
    • Check logs: tail -50 storage/logs/laravel.log | grep ERROR

========================================
VERIFICATION SQL
========================================

# Check migration applied
mysql -u [DB_USER] -p[DB_PASS] [DB_NAME] -e "
SELECT migration FROM migrations
WHERE migration = '2025_11_22_092125_add_joint_ownership_to_liabilities_table';
"

# Check new columns exist
mysql -u [DB_USER] -p[DB_PASS] [DB_NAME] -e "DESCRIBE liabilities;"
# Look for: ownership_type, joint_owner_id, trust_id

# Check data integrity
mysql -u [DB_USER] -p[DB_PASS] [DB_NAME] -e "
SELECT COUNT(*) as total,
       COUNT(CASE WHEN ownership_type = 'individual' THEN 1 END) as individual
FROM liabilities;
"
# All should be 'individual'

========================================
ROLLBACK (if needed)
========================================

IF CRITICAL ISSUES:

1. Rollback migration:
   php artisan migrate:rollback --step=1

2. Restore code:
   backup_name="[your backup from step 3]"
   cp -r ~/backups/$backup_name/Models/* app/Models/
   cp -r ~/backups/$backup_name/Services/* app/Services/
   cp -r ~/backups/$backup_name/estate/* resources/js/components/Estate/
   cp -r ~/backups/$backup_name/investment/* resources/js/components/Investment/
   rm -rf resources/js/constants/

3. Rebuild:
   rm -rf public/build/*
   NODE_ENV=production npm run build
   php artisan cache:clear
   php artisan config:clear
   php artisan config:cache
   php artisan route:cache

4. Verify:
   curl -I https://csjones.co/tengo

========================================
SUCCESS CRITERIA
========================================

✓ Migration shows "Ran" in migrate:status
✓ Database has ownership_type, joint_owner_id, trust_id columns
✓ All existing liabilities have ownership_type = 'individual'
✓ Frontend manifest.json exists at public/build/manifest.json
✓ 100+ files in public/build/assets/
✓ Homepage returns HTTP 200
✓ User can login
✓ Dashboard renders all cards
✓ IHT Planning shows "4.7%" methodology note
✓ Investment shows ISA allowances (no TAX_CONFIG errors)
✓ No ERROR messages in laravel.log
✓ Page load < 3 seconds

========================================
COMMON ISSUES
========================================

Issue: Migration fails with "Table 'liabilities' doesn't exist"
Fix: Check DB connection, verify .env credentials

Issue: Frontend error "Cannot read property 'ISA_ANNUAL_ALLOWANCE'"
Fix: Verify resources/js/constants/taxConfig.js uploaded correctly

Issue: "Call to undefined method [jointOwner]"
Fix: Re-upload app/Models/Estate/Liability.php, clear config cache

Issue: Assets 404 errors
Fix: Re-run npm run build, verify manifest.json location

Issue: Build fails "Cannot find module"
Fix: rm -rf node_modules && npm ci && npm run build

========================================
MONITORING
========================================

Monitor for 30 minutes post-deployment:

# Real-time log
tail -f storage/logs/laravel.log

# Check for errors every 5 minutes
tail -100 storage/logs/laravel.log | grep ERROR

Watch for:
❌ SQLSTATE errors (database issues)
❌ "Call to undefined" errors (missing files)
❌ 500 errors (application broken)
✅ INFO messages (normal)

========================================
RESOURCES
========================================

Full Guide: /DEPLOYMENT/DEPLOYMENT_PATCH_v0.2.11_22Nov2025.md
Checklist: /DEPLOYMENT/DEPLOYMENT_v0.2.11_CHECKLIST.md
SQL Verification: /DEPLOYMENT/verify_v0.2.11_migration.sql
Changes Log: friFixes21Nov.md sections 33-34

Test Accounts:
- Admin: admin@fps.com / admin123
- Demo: demo@fps.com / password

Production URL: https://csjones.co/tengo
Application Root: ~/tengo-app/

========================================
DEPLOYMENT LOG
========================================

Date/Time: ___________________
Deployed By: __________________
Database Backup: ______________
Code Backup: __________________
Migration Result: _____________
Build Result: _________________
Test Result: __________________
Issues: _______________________
Rollback Required: Yes / No
Completion Time: ______________

========================================

Built with Claude Code by Anthropic

<?php

declare(strict_types=1);

namespace App\Services\Onboarding;

use App\Models\OnboardingProgress;
use App\Models\User;
use Carbon\Carbon;
use Illuminate\Support\Facades\DB;

class OnboardingService
{
    public function __construct(
        private EstateOnboardingFlow $estateFlow
    ) {}

    /**
     * Get the onboarding status for a user
     */
    public function getOnboardingStatus(int $userId): array
    {
        $user = User::findOrFail($userId);

        $status = [
            'onboarding_completed' => $user->onboarding_completed,
            'focus_area' => $user->onboarding_focus_area,
            'current_step' => $user->onboarding_current_step,
            'skipped_steps' => $user->onboarding_skipped_steps ?? [],
            'started_at' => $user->onboarding_started_at?->toISOString(),
            'completed_at' => $user->onboarding_completed_at?->toISOString(),
            'progress_percentage' => 0,
            'total_steps' => 0,
            'completed_steps' => 0,
        ];

        if ($user->onboarding_focus_area) {
            $progress = $this->calculateProgress($userId);
            $status['progress_percentage'] = $progress['percentage'];
            $status['total_steps'] = $progress['total'];
            $status['completed_steps'] = $progress['completed'];
        }

        return $status;
    }

    /**
     * Set the focus area for user's onboarding
     */
    public function setFocusArea(int $userId, string $focusArea): User
    {
        $user = User::findOrFail($userId);

        $user->update([
            'onboarding_focus_area' => $focusArea,
            'onboarding_started_at' => $user->onboarding_started_at ?? Carbon::now(),
            'onboarding_current_step' => $this->getFirstStep($focusArea),
        ]);

        return $user->fresh();
    }

    /**
     * Get the first step for a focus area
     */
    private function getFirstStep(string $focusArea): string
    {
        if ($focusArea === 'estate') {
            $steps = $this->estateFlow->getSteps();
            $firstStep = array_key_first($steps);

            return $firstStep;
        }

        // Future: Add other focus areas
        return 'personal_info';
    }

    /**
     * Save progress for a specific step
     */
    public function saveStepProgress(int $userId, string $stepName, array $data): OnboardingProgress
    {
        $user = User::findOrFail($userId);

        if (! $user->onboarding_focus_area) {
            throw new \Exception('Focus area not set');
        }

        // Process step-specific data to save to actual database tables
        $this->processStepData($userId, $stepName, $data);

        // Find or create progress record for this step
        $progress = OnboardingProgress::updateOrCreate(
            [
                'user_id' => $userId,
                'focus_area' => $user->onboarding_focus_area,
                'step_name' => $stepName,
            ],
            [
                'step_data' => $data,
                'completed' => true,
                'completed_at' => Carbon::now(),
            ]
        );

        // Update current step on user
        $nextStep = $this->getNextStep($userId, $stepName);
        $user->update([
            'onboarding_current_step' => $nextStep ?? $stepName,
        ]);

        return $progress;
    }

    /**
     * Process step-specific data and save to proper database tables
     */
    protected function processStepData(int $userId, string $stepName, array $data): void
    {
        switch ($stepName) {
            case 'personal_info':
                $this->processPersonalInfo($userId, $data);
                break;

            case 'income':
                $this->processIncomeInfo($userId, $data);
                break;

            case 'expenditure':
                $this->processExpenditureInfo($userId, $data);
                break;

            case 'domicile_info':
                $this->processDomicileInfo($userId, $data);
                break;

            case 'assets':
                $this->processAssets($userId, $data);
                break;

            case 'liabilities':
                $this->processLiabilities($userId, $data);
                break;

            case 'protection_policies':
                $this->processProtectionPolicies($userId, $data);
                break;

            case 'family_info':
                $this->processFamilyInfo($userId, $data);
                break;

            case 'will_info':
                $this->processWillInfo($userId, $data);
                break;

                // Add more cases as we implement other steps
        }
    }

    /**
     * Process personal information and update user record
     */
    protected function processPersonalInfo(int $userId, array $data): void
    {
        $user = User::findOrFail($userId);

        // Update user personal information fields
        $user->update([
            'date_of_birth' => $data['date_of_birth'] ?? null,
            'gender' => $data['gender'] ?? null,
            'marital_status' => $data['marital_status'] ?? null,
            'national_insurance_number' => $data['national_insurance_number'] ?? null,
            'address_line_1' => $data['address_line_1'] ?? null,
            'address_line_2' => $data['address_line_2'] ?? null,
            'city' => $data['city'] ?? null,
            'county' => $data['county'] ?? null,
            'postcode' => $data['postcode'] ?? null,
            'phone' => $data['phone'] ?? null,
            'health_status' => $data['health_status'] ?? null,
            'smoking_status' => $data['smoking_status'] ?? null,
            'education_level' => $data['education_level'] ?? null,
        ]);
    }

    /**
     * Process domicile information and update user record
     */
    protected function processDomicileInfo(int $userId, array $data): void
    {
        $user = User::findOrFail($userId);

        // Update user domicile fields
        $updateData = [
            'domicile_status' => $data['domicile_status'] ?? null,
            'country_of_birth' => $data['country_of_birth'] ?? null,
        ];

        // Only update these fields if non-UK domiciled
        if (isset($data['domicile_status']) && $data['domicile_status'] === 'non_uk_domiciled') {
            $updateData['uk_arrival_date'] = $data['uk_arrival_date'] ?? null;
            $updateData['years_uk_resident'] = $data['years_uk_resident'] ?? null;
            $updateData['deemed_domicile_date'] = $data['deemed_domicile_date'] ?? null;
        }

        $user->update($updateData);
    }

    /**
     * Process family information and save to family_members table
     */
    protected function processFamilyInfo(int $userId, array $data): void
    {
        $user = User::findOrFail($userId);

        // Save charitable bequest preference
        if (isset($data['charitable_bequest'])) {
            $user->update([
                'charitable_bequest' => $data['charitable_bequest'],
            ]);
        }

        if (! isset($data['family_members']) || ! is_array($data['family_members'])) {
            return;
        }

        // Get existing family members added during onboarding
        $existingMembers = \App\Models\FamilyMember::where('user_id', $userId)
            ->whereNotNull('date_of_birth')
            ->get()
            ->keyBy('name');

        foreach ($data['family_members'] as $memberData) {
            // Special handling for spouse with email - attempt account linking
            if ($memberData['relationship'] === 'spouse' && ! empty($memberData['email'])) {
                $this->handleSpouseLinking($user, $memberData);

                continue; // Skip normal family member creation as it's handled by spouse linking
            }

            // Check if this member already exists (by name)
            $existingMember = $existingMembers->get($memberData['name']);

            if ($existingMember) {
                // Update existing member
                $existingMember->update([
                    'relationship' => $memberData['relationship'],
                    'date_of_birth' => $memberData['date_of_birth'],
                    'is_dependent' => $memberData['is_dependent'] ?? false,
                ]);
            } else {
                // Create new family member
                \App\Models\FamilyMember::create([
                    'user_id' => $userId,
                    'name' => $memberData['name'],
                    'relationship' => $memberData['relationship'],
                    'date_of_birth' => $memberData['date_of_birth'],
                    'is_dependent' => $memberData['is_dependent'] ?? false,
                ]);
            }
        }
    }

    /**
     * Handle spouse account linking during onboarding
     */
    protected function handleSpouseLinking(User $user, array $spouseData): void
    {
        $spouseEmail = strtolower(trim($spouseData['email']));

        // Check if spouse account exists
        $spouseAccount = User::where('email', $spouseEmail)->first();

        if ($spouseAccount) {
            // Account exists - link them
            if ($spouseAccount->id === $user->id) {
                // Can't link to self
                return;
            }

            if ($user->spouse_id === $spouseAccount->id) {
                // Already linked
                return;
            }

            if ($spouseAccount->spouse_id && $spouseAccount->spouse_id !== $user->id) {
                // Spouse already linked to someone else
                return;
            }

            // Link the accounts bidirectionally
            $user->update([
                'spouse_id' => $spouseAccount->id,
                'marital_status' => 'married',
            ]);

            $spouseAccount->update([
                'spouse_id' => $user->id,
                'marital_status' => 'married',
            ]);

            // Clear cached protection analysis for both users since spouse linkage affects completeness
            \Illuminate\Support\Facades\Cache::forget("protection_analysis_{$user->id}");
            \Illuminate\Support\Facades\Cache::forget("protection_analysis_{$spouseAccount->id}");

            // Create bidirectional spouse data sharing permissions
            \App\Models\SpousePermission::updateOrCreate(
                [
                    'user_id' => $user->id,
                    'spouse_id' => $spouseAccount->id,
                ],
                [
                    'can_view_data' => true,
                    'can_edit_data' => false,
                    'permission_granted_at' => now(),
                ]
            );

            \App\Models\SpousePermission::updateOrCreate(
                [
                    'user_id' => $spouseAccount->id,
                    'spouse_id' => $user->id,
                ],
                [
                    'can_view_data' => true,
                    'can_edit_data' => false,
                    'permission_granted_at' => now(),
                ]
            );

            // Create family member record for the current user
            \App\Models\FamilyMember::updateOrCreate(
                [
                    'user_id' => $user->id,
                    'relationship' => 'spouse',
                ],
                [
                    'name' => $spouseAccount->name,
                    'date_of_birth' => $spouseData['date_of_birth'] ?? $spouseAccount->date_of_birth,
                    'is_dependent' => false,
                ]
            );

            // Create reciprocal family member record for spouse
            \App\Models\FamilyMember::updateOrCreate(
                [
                    'user_id' => $spouseAccount->id,
                    'relationship' => 'spouse',
                ],
                [
                    'name' => $user->name,
                    'date_of_birth' => $user->date_of_birth,
                    'is_dependent' => false,
                ]
            );
        } else {
            // Account doesn't exist yet - just create family member record
            \App\Models\FamilyMember::updateOrCreate(
                [
                    'user_id' => $user->id,
                    'relationship' => 'spouse',
                ],
                [
                    'name' => $spouseData['name'],
                    'date_of_birth' => $spouseData['date_of_birth'],
                    'is_dependent' => false,
                ]
            );
        }
    }

    /**
     * Process will information and save to wills table
     */
    protected function processWillInfo(int $userId, array $data): void
    {
        $user = User::findOrFail($userId);

        // Determine has_will value: treat null as false (no will)
        $hasWill = isset($data['has_will']) && $data['has_will'] === true;

        // Create or update will record
        $willData = [
            'user_id' => $userId,
            'has_will' => $hasWill,
        ];

        // Add last reviewed date if will exists and date is provided
        if ($hasWill && ! empty($data['will_last_updated'])) {
            $willData['will_last_updated'] = $data['will_last_updated'];
        }

        // Add executor name if provided
        if ($hasWill && ! empty($data['executor_name'])) {
            $willData['executor_name'] = $data['executor_name'];
        }

        // Use updateOrCreate to handle both new and existing records
        \App\Models\Estate\Will::updateOrCreate(
            ['user_id' => $userId],
            $willData
        );
    }

    /**
     * Process income information and update user record
     */
    protected function processIncomeInfo(int $userId, array $data): void
    {
        $user = User::findOrFail($userId);

        // Update user income and employment fields
        $user->update([
            'occupation' => $data['occupation'] ?? null,
            'employer' => $data['employer'] ?? null,
            'industry' => $data['industry'] ?? null,
            'employment_status' => $data['employment_status'] ?? null,
            'target_retirement_age' => $data['target_retirement_age'] ?? null,
            'retirement_date' => $data['retirement_date'] ?? null,
            'annual_employment_income' => $data['annual_employment_income'] ?? 0,
            'annual_self_employment_income' => $data['annual_self_employment_income'] ?? 0,
            'annual_dividend_income' => $data['annual_dividend_income'] ?? 0,
            'annual_interest_income' => $data['annual_interest_income'] ?? 0,
            'annual_other_income' => $data['annual_other_income'] ?? 0,
        ]);

        // Update or create retirement profile if retirement age is provided
        if (isset($data['target_retirement_age'])) {
            $currentAge = $user->date_of_birth ? \Carbon\Carbon::parse($user->date_of_birth)->age : 30;

            \App\Models\RetirementProfile::updateOrCreate(
                ['user_id' => $userId],
                [
                    'current_age' => $currentAge,
                    'target_retirement_age' => $data['target_retirement_age'],
                ]
            );
        }

        // If user is retired, calculate their retirement age from retirement date
        if ($data['employment_status'] === 'retired' && isset($data['retirement_date']) && $user->date_of_birth) {
            $birthDate = \Carbon\Carbon::parse($user->date_of_birth);
            $retirementDate = \Carbon\Carbon::parse($data['retirement_date']);
            $retirementAge = $retirementDate->diffInYears($birthDate);
            $currentAge = \Carbon\Carbon::now()->diffInYears($birthDate);

            \App\Models\RetirementProfile::updateOrCreate(
                ['user_id' => $userId],
                [
                    'current_age' => $currentAge,
                    'target_retirement_age' => $retirementAge,
                ]
            );
        }
    }

    /**
     * Process expenditure information and update user record
     */
    protected function processExpenditureInfo(int $userId, array $data): void
    {
        $user = User::findOrFail($userId);

        // Check if this is separate mode data (has userData and spouseData keys)
        if (isset($data['userData']) && isset($data['spouseData'])) {
            // Separate mode: Update current user with userData
            $userData = $data['userData'];
            $user->update([
                'food_groceries' => $userData['food_groceries'] ?? 0,
                'transport_fuel' => $userData['transport_fuel'] ?? 0,
                'healthcare_medical' => $userData['healthcare_medical'] ?? 0,
                'insurance' => $userData['insurance'] ?? 0,
                'mobile_phones' => $userData['mobile_phones'] ?? 0,
                'internet_tv' => $userData['internet_tv'] ?? 0,
                'subscriptions' => $userData['subscriptions'] ?? 0,
                'clothing_personal_care' => $userData['clothing_personal_care'] ?? 0,
                'entertainment_dining' => $userData['entertainment_dining'] ?? 0,
                'holidays_travel' => $userData['holidays_travel'] ?? 0,
                'pets' => $userData['pets'] ?? 0,
                'childcare' => $userData['childcare'] ?? 0,
                'school_fees' => $userData['school_fees'] ?? 0,
                'children_activities' => $userData['children_activities'] ?? 0,
                'other_expenditure' => $userData['other_expenditure'] ?? 0,
                'monthly_expenditure' => $userData['monthly_expenditure'] ?? 0,
                'annual_expenditure' => $userData['annual_expenditure'] ?? 0,
                'expenditure_entry_mode' => $userData['expenditure_entry_mode'] ?? 'category',
            ]);

            // Update spouse with spouseData
            if ($user->spouse_id) {
                $spouse = User::find($user->spouse_id);
                if ($spouse) {
                    $spouseData = $data['spouseData'];
                    $spouse->update([
                        'food_groceries' => $spouseData['food_groceries'] ?? 0,
                        'transport_fuel' => $spouseData['transport_fuel'] ?? 0,
                        'healthcare_medical' => $spouseData['healthcare_medical'] ?? 0,
                        'insurance' => $spouseData['insurance'] ?? 0,
                        'mobile_phones' => $spouseData['mobile_phones'] ?? 0,
                        'internet_tv' => $spouseData['internet_tv'] ?? 0,
                        'subscriptions' => $spouseData['subscriptions'] ?? 0,
                        'clothing_personal_care' => $spouseData['clothing_personal_care'] ?? 0,
                        'entertainment_dining' => $spouseData['entertainment_dining'] ?? 0,
                        'holidays_travel' => $spouseData['holidays_travel'] ?? 0,
                        'pets' => $spouseData['pets'] ?? 0,
                        'childcare' => $spouseData['childcare'] ?? 0,
                        'school_fees' => $spouseData['school_fees'] ?? 0,
                        'children_activities' => $spouseData['children_activities'] ?? 0,
                        'other_expenditure' => $spouseData['other_expenditure'] ?? 0,
                        'monthly_expenditure' => $spouseData['monthly_expenditure'] ?? 0,
                        'annual_expenditure' => $spouseData['annual_expenditure'] ?? 0,
                        'expenditure_entry_mode' => $spouseData['expenditure_entry_mode'] ?? 'category',
                    ]);
                }
            }
        } else {
            // Joint mode or single user: Update user with flat data
            $user->update([
                'food_groceries' => $data['food_groceries'] ?? 0,
                'transport_fuel' => $data['transport_fuel'] ?? 0,
                'healthcare_medical' => $data['healthcare_medical'] ?? 0,
                'insurance' => $data['insurance'] ?? 0,
                'mobile_phones' => $data['mobile_phones'] ?? 0,
                'internet_tv' => $data['internet_tv'] ?? 0,
                'subscriptions' => $data['subscriptions'] ?? 0,
                'clothing_personal_care' => $data['clothing_personal_care'] ?? 0,
                'entertainment_dining' => $data['entertainment_dining'] ?? 0,
                'holidays_travel' => $data['holidays_travel'] ?? 0,
                'pets' => $data['pets'] ?? 0,
                'childcare' => $data['childcare'] ?? 0,
                'school_fees' => $data['school_fees'] ?? 0,
                'children_activities' => $data['children_activities'] ?? 0,
                'other_expenditure' => $data['other_expenditure'] ?? 0,
                'monthly_expenditure' => $data['monthly_expenditure'] ?? 0,
                'annual_expenditure' => $data['annual_expenditure'] ?? 0,
                'expenditure_entry_mode' => $data['expenditure_entry_mode'] ?? 'category',
            ]);
        }
    }

    /**
     * Process assets information and save to properties table
     */
    protected function processAssets(int $userId, array $data): void
    {
        // Process Properties
        if (isset($data['properties']) && is_array($data['properties'])) {
            $totalMonthlyRentalIncome = 0;

            foreach ($data['properties'] as $propertyData) {
                $monthlyRental = $propertyData['monthly_rental_income'] ?? 0;

                // Create property record
                $property = \App\Models\Property::create([
                    'user_id' => $userId,
                    'property_type' => $propertyData['property_type'],
                    'ownership_type' => $propertyData['ownership_type'] ?? 'individual',
                    'address_line_1' => $propertyData['address_line_1'],
                    'address_line_2' => $propertyData['address_line_2'] ?? null,
                    'city' => $propertyData['city'] ?? null,
                    'postcode' => $propertyData['postcode'],
                    'country' => $propertyData['country'] ?? 'United Kingdom',
                    'current_value' => $propertyData['current_value'],
                    'outstanding_mortgage' => $propertyData['outstanding_mortgage'] ?? 0,
                    'monthly_rental_income' => $monthlyRental,
                    'annual_rental_income' => $monthlyRental * 12,
                ]);

                // Accumulate rental income for updating user's total rental income
                if ($monthlyRental > 0) {
                    $totalMonthlyRentalIncome += $monthlyRental;
                }

                // If property has a mortgage, create a mortgage record linked to this property
                if (isset($propertyData['outstanding_mortgage']) && $propertyData['outstanding_mortgage'] > 0) {
                    \App\Models\Mortgage::create([
                        'property_id' => $property->id,
                        'user_id' => $userId,
                        'lender_name' => 'Mortgage Provider', // Default name from onboarding
                        'mortgage_type' => 'repayment', // Default to repayment
                        'original_loan_amount' => $propertyData['outstanding_mortgage'], // Use current balance as original
                        'outstanding_balance' => $propertyData['outstanding_mortgage'],
                        'interest_rate' => 0.0350, // Default 3.5% if not provided
                        'rate_type' => 'fixed',
                        'monthly_payment' => $this->calculateMortgagePayment(
                            $propertyData['outstanding_mortgage'],
                            0.0350,
                            25
                        ),
                        'start_date' => now()->subYears(5), // Default 5 years ago
                        'maturity_date' => now()->addYears(20), // Default 20 years remaining
                        'remaining_term_months' => 240, // 20 years * 12 months
                    ]);
                }
            }

            // Update user's rental income if any buy-to-let properties were added
            if ($totalMonthlyRentalIncome > 0) {
                $user = User::find($userId);
                $user->update([
                    'annual_rental_income' => $totalMonthlyRentalIncome * 12,
                ]);
            }
        }

        // Process Investment Accounts
        if (isset($data['investments']) && is_array($data['investments'])) {
            foreach ($data['investments'] as $investmentData) {
                // Map frontend account types to database enum values
                $accountTypeMap = [
                    'stocks_shares_isa' => 'isa',
                    'gia' => 'gia',
                    'offshore_bond' => 'offshore_bond',
                    'other' => 'gia', // Default 'other' to GIA
                ];

                $accountType = $accountTypeMap[$investmentData['account_type']] ?? 'gia';
                $ownershipType = $investmentData['ownership_type'] ?? 'individual';

                // IMPORTANT: For joint ownership, divide values by 2 to store each user's share
                // This ensures consistency with properties and all other joint assets
                $currentValue = $investmentData['current_value'];
                $isaAllowanceUsed = $investmentData['isa_allowance_used'] ?? 0;
                $ownershipPercentage = 100.00;

                if ($ownershipType === 'joint') {
                    $currentValue = $currentValue / 2;
                    $isaAllowanceUsed = $isaAllowanceUsed / 2;
                    $ownershipPercentage = 50.00;
                }

                \App\Models\Investment\InvestmentAccount::create([
                    'user_id' => $userId,
                    'provider' => $investmentData['institution'],
                    'account_type' => $accountType,
                    'country' => $investmentData['country'] ?? 'United Kingdom',
                    'current_value' => $currentValue,
                    'ownership_type' => $ownershipType,
                    'ownership_percentage' => $ownershipPercentage,
                    'isa_subscription_current_year' => $isaAllowanceUsed,
                    'tax_year' => '2025/26',
                    'isa_type' => $accountType === 'isa' ? 'stocks_and_shares' : null,
                ]);
            }
        }

        // Process Cash/Savings Accounts
        if (isset($data['cash']) && is_array($data['cash'])) {
            foreach ($data['cash'] as $cashData) {
                $isCashISA = $cashData['account_type'] === 'cash_isa';
                $ownershipType = $cashData['ownership_type'] ?? 'individual';

                // IMPORTANT: For joint ownership, divide values by 2 to store each user's share
                $currentBalance = $cashData['current_balance'];
                $isaAllowanceUsed = $cashData['isa_allowance_used'] ?? 0;

                if ($ownershipType === 'joint') {
                    $currentBalance = $currentBalance / 2;
                    $isaAllowanceUsed = $isaAllowanceUsed / 2;
                }

                \App\Models\SavingsAccount::create([
                    'user_id' => $userId,
                    'institution' => $cashData['institution'],
                    'account_type' => $cashData['account_type'],
                    'country' => $cashData['country'] ?? 'United Kingdom',
                    'current_balance' => $currentBalance,
                    'interest_rate' => isset($cashData['interest_rate']) ? $cashData['interest_rate'] / 100 : 0,
                    'ownership_type' => $ownershipType,
                    'is_isa' => $isCashISA,
                    'isa_type' => $isCashISA ? 'cash' : null,
                    'isa_subscription_year' => $isCashISA ? '2025/26' : null,
                    'isa_subscription_amount' => $isCashISA ? $isaAllowanceUsed : null,
                    'access_type' => $this->mapAccessType($cashData['account_type']),
                ]);
            }
        }
    }

    /**
     * Map account type to access type for savings accounts
     */
    private function mapAccessType(string $accountType): string
    {
        return match ($accountType) {
            'current_account', 'cash_isa', 'easy_access' => 'immediate',
            'notice_account' => 'notice',
            'fixed_term' => 'fixed',
            default => 'immediate',
        };
    }

    /**
     * Calculate approximate monthly mortgage payment
     */
    private function calculateMortgagePayment(float $principal, float $annualRate, int $years): float
    {
        if ($annualRate == 0) {
            return $principal / ($years * 12);
        }

        $monthlyRate = $annualRate / 12;
        $numPayments = $years * 12;

        $payment = $principal * ($monthlyRate * pow(1 + $monthlyRate, $numPayments)) /
                   (pow(1 + $monthlyRate, $numPayments) - 1);

        return round($payment, 2);
    }

    /**
     * Process liabilities information and save to liabilities table
     */
    protected function processLiabilities(int $userId, array $data): void
    {
        if (! isset($data['liabilities']) || ! is_array($data['liabilities'])) {
            return;
        }

        foreach ($data['liabilities'] as $liabilityData) {
            // Skip mortgages - they should be linked to properties and created in processAssets
            if ($liabilityData['type'] === 'mortgage') {
                continue;
            }

            // Convert interest rate from percentage to decimal (e.g., 27 -> 0.27)
            $interestRate = isset($liabilityData['interest_rate'])
                ? $liabilityData['interest_rate'] / 100
                : null;

            // Create liability record
            \App\Models\Estate\Liability::create([
                'user_id' => $userId,
                'liability_type' => $liabilityData['type'],
                'liability_name' => $liabilityData['lender'],
                'country' => $liabilityData['country'] ?? 'United Kingdom',
                'current_balance' => $liabilityData['outstanding_balance'],
                'monthly_payment' => $liabilityData['monthly_payment'] ?? null,
                'interest_rate' => $interestRate,
                'notes' => $liabilityData['purpose'] ?? null,
            ]);
        }
    }

    /**
     * Process protection policies and save to appropriate policy tables
     */
    protected function processProtectionPolicies(int $userId, array $data): void
    {
        if (! isset($data['policies']) || ! is_array($data['policies'])) {
            return;
        }

        foreach ($data['policies'] as $policyData) {
            $policyType = $policyData['policyType'];

            switch ($policyType) {
                case 'life':
                    $this->createLifeInsurancePolicy($userId, $policyData);
                    break;

                case 'criticalIllness':
                    $this->createCriticalIllnessPolicy($userId, $policyData);
                    break;

                case 'incomeProtection':
                    $this->createIncomeProtectionPolicy($userId, $policyData);
                    break;

                    // Note: disability and sicknessIllness might need their own tables
                    // For now, we'll skip them or you can add tables for these
            }
        }
    }

    /**
     * Create life insurance policy record
     */
    protected function createLifeInsurancePolicy(int $userId, array $data): void
    {
        $startDate = ! empty($data['start_date']) ? $data['start_date'] : now()->toDateString();
        $endDate = ! empty($data['end_date']) ? $data['end_date'] : null;

        // Calculate term years if end date provided or use provided term_years
        $termYears = $data['term_years'] ?? 25; // Default
        if ($endDate) {
            $start = \Carbon\Carbon::parse($startDate);
            $end = \Carbon\Carbon::parse($endDate);
            $termYears = $start->diffInYears($end);
        }

        // Get policy type from data (use policy_type if provided, otherwise default to term)
        $policyType = $data['policy_type'] ?? 'term';

        // Build the policy data
        $policyData = [
            'user_id' => $userId,
            'policy_type' => $policyType,
            'provider' => $data['provider'],
            'policy_number' => $data['policy_number'] ?? null,
            'sum_assured' => $data['sum_assured'] ?? $data['coverage_amount'],
            'premium_amount' => $data['premium_amount'],
            'premium_frequency' => $data['premium_frequency'] === 'annual' ? 'annually' : 'monthly',
            'policy_start_date' => $startDate,
            'policy_term_years' => $termYears,
            'in_trust' => $data['in_trust'] ?? false,
            'beneficiaries' => $data['beneficiaries'] ?? null,
        ];

        // Add decreasing policy specific fields if policy type is decreasing_term
        if ($policyType === 'decreasing_term') {
            $policyData['start_value'] = $data['start_value'] ?? null;
            $policyData['decreasing_rate'] = $data['decreasing_rate'] ?? null;
        }

        \App\Models\LifeInsurancePolicy::create($policyData);
    }

    /**
     * Create critical illness policy record
     */
    protected function createCriticalIllnessPolicy(int $userId, array $data): void
    {
        $startDate = ! empty($data['start_date']) ? $data['start_date'] : now()->toDateString();
        $endDate = ! empty($data['end_date']) ? $data['end_date'] : null;

        // Calculate term years if end date provided
        $termYears = 25; // Default
        if ($endDate) {
            $start = \Carbon\Carbon::parse($startDate);
            $end = \Carbon\Carbon::parse($endDate);
            $termYears = $start->diffInYears($end);
        }

        \App\Models\CriticalIllnessPolicy::create([
            'user_id' => $userId,
            'policy_type' => 'standalone', // Default
            'provider' => $data['provider'],
            'policy_number' => $data['policy_number'] ?? null,
            'sum_assured' => $data['coverage_amount'],
            'premium_amount' => $data['premium_amount'],
            'premium_frequency' => $data['premium_frequency'] === 'annual' ? 'annually' : 'monthly',
            'policy_start_date' => $startDate,
            'policy_term_years' => $termYears,
        ]);
    }

    /**
     * Create income protection policy record
     */
    protected function createIncomeProtectionPolicy(int $userId, array $data): void
    {
        $startDate = ! empty($data['start_date']) ? $data['start_date'] : now()->toDateString();

        \App\Models\IncomeProtectionPolicy::create([
            'user_id' => $userId,
            'provider' => $data['provider'],
            'policy_number' => $data['policy_number'] ?? null,
            'benefit_amount' => $data['coverage_amount'],
            'benefit_frequency' => 'monthly',
            'deferred_period_weeks' => $data['waiting_period_weeks'] ?? 13, // Default 13 weeks
            'benefit_period_months' => $data['benefit_period_months'] ?? null,
            'premium_amount' => $data['premium_amount'],
            'policy_start_date' => $startDate,
        ]);
    }

    /**
     * Mark a step as skipped
     */
    public function skipStep(int $userId, string $stepName): OnboardingProgress
    {
        $user = User::findOrFail($userId);

        if (! $user->onboarding_focus_area) {
            throw new \Exception('Focus area not set');
        }

        // Create or update progress record
        $progress = OnboardingProgress::updateOrCreate(
            [
                'user_id' => $userId,
                'focus_area' => $user->onboarding_focus_area,
                'step_name' => $stepName,
            ],
            [
                'skipped' => true,
                'skip_reason_shown' => true,
            ]
        );

        // Add to skipped steps array in user record
        $skippedSteps = $user->onboarding_skipped_steps ?? [];
        if (! in_array($stepName, $skippedSteps)) {
            $skippedSteps[] = $stepName;
        }

        // Update current step to next step
        $nextStep = $this->getNextStep($userId, $stepName);
        $user->update([
            'onboarding_skipped_steps' => $skippedSteps,
            'onboarding_current_step' => $nextStep ?? $stepName,
        ]);

        return $progress;
    }

    /**
     * Complete the onboarding process
     */
    public function completeOnboarding(int $userId): User
    {
        $user = User::findOrFail($userId);

        $user->update([
            'onboarding_completed' => true,
            'onboarding_completed_at' => Carbon::now(),
        ]);

        return $user->fresh();
    }

    /**
     * Restart the onboarding process
     */
    public function restartOnboarding(int $userId): User
    {
        $user = User::findOrFail($userId);

        DB::transaction(function () use ($user) {
            // Delete all progress records
            OnboardingProgress::where('user_id', $user->id)->delete();

            // Reset user onboarding fields
            $user->update([
                'onboarding_completed' => false,
                'onboarding_focus_area' => null,
                'onboarding_current_step' => null,
                'onboarding_skipped_steps' => null,
                'onboarding_started_at' => null,
                'onboarding_completed_at' => null,
            ]);
        });

        return $user->fresh();
    }

    /**
     * Calculate progress percentage for a user
     */
    public function calculateProgress(int $userId): array
    {
        $user = User::findOrFail($userId);

        if (! $user->onboarding_focus_area) {
            return [
                'percentage' => 0,
                'total' => 0,
                'completed' => 0,
            ];
        }

        $steps = $this->getOnboardingSteps($user->onboarding_focus_area, $userId);
        $totalSteps = count($steps);

        $completedSteps = OnboardingProgress::where('user_id', $userId)
            ->where('focus_area', $user->onboarding_focus_area)
            ->where(function ($query) {
                $query->where('completed', true)
                    ->orWhere('skipped', true);
            })
            ->count();

        $percentage = $totalSteps > 0 ? round(($completedSteps / $totalSteps) * 100) : 0;

        return [
            'percentage' => $percentage,
            'total' => $totalSteps,
            'completed' => $completedSteps,
        ];
    }

    /**
     * Get onboarding steps for a focus area
     */
    public function getOnboardingSteps(string $focusArea, ?int $userId = null): array
    {
        if ($focusArea === 'estate') {
            if ($userId) {
                $user = User::find($userId);
                $userData = $this->getUserDataArray($user);

                return $this->estateFlow->getFilteredSteps($userData);
            }

            return $this->estateFlow->getSteps();
        }

        // Future: Add other focus areas
        return [];
    }

    /**
     * Get next step name
     */
    public function getNextStep(int $userId, string $currentStep): ?string
    {
        $user = User::findOrFail($userId);

        if (! $user->onboarding_focus_area) {
            return null;
        }

        if ($user->onboarding_focus_area === 'estate') {
            $userData = $this->getUserDataArray($user);

            return $this->estateFlow->getNextStep($currentStep, $userData);
        }

        return null;
    }

    /**
     * Get previous step name
     */
    public function getPreviousStep(int $userId, string $currentStep): ?string
    {
        $user = User::findOrFail($userId);

        if (! $user->onboarding_focus_area) {
            return null;
        }

        if ($user->onboarding_focus_area === 'estate') {
            $userData = $this->getUserDataArray($user);

            return $this->estateFlow->getPreviousStep($currentStep, $userData);
        }

        return null;
    }

    /**
     * Check if a step should be shown based on progressive disclosure
     */
    public function shouldShowStep(int $userId, string $stepName): bool
    {
        $user = User::findOrFail($userId);

        if (! $user->onboarding_focus_area) {
            return false;
        }

        if ($user->onboarding_focus_area === 'estate') {
            $userData = $this->getUserDataArray($user);

            return $this->estateFlow->shouldShowStep($stepName, $userData);
        }

        return false;
    }

    /**
     * Get skip reason text for a step
     */
    public function getSkipReasonText(string $focusArea, string $stepName): ?string
    {
        if ($focusArea === 'estate') {
            return $this->estateFlow->getSkipReason($stepName);
        }

        return null;
    }

    /**
     * Get step data for a user
     */
    public function getStepData(int $userId, string $stepName): ?array
    {
        $user = User::findOrFail($userId);

        if (! $user->onboarding_focus_area) {
            return null;
        }

        $progress = OnboardingProgress::where('user_id', $userId)
            ->where('focus_area', $user->onboarding_focus_area)
            ->where('step_name', $stepName)
            ->first();

        return $progress?->step_data;
    }

    /**
     * Convert User model to array for step logic
     */
    private function getUserDataArray(?User $user): array
    {
        if (! $user) {
            return [];
        }

        $userData = [
            'marital_status' => $user->marital_status,
            'annual_employment_income' => $user->annual_employment_income,
            'annual_self_employment_income' => $user->annual_self_employment_income,
            'annual_rental_income' => $user->annual_rental_income,
            'annual_dividend_income' => $user->annual_dividend_income,
            'annual_interest_income' => $user->annual_interest_income,
            'annual_other_income' => $user->annual_other_income,
        ];

        // Add step data from onboarding progress
        $progressRecords = OnboardingProgress::where('user_id', $user->id)
            ->where('focus_area', $user->onboarding_focus_area)
            ->get();

        foreach ($progressRecords as $progress) {
            if ($progress->step_data) {
                $userData = array_merge($userData, $progress->step_data);
            }
        }

        return $userData;
    }
}
